{% extends 'base.html' %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
{% endblock %}

{% block content %}
<div class="profile-header">
  <div class="avatar-wrapper">
    <div id="userAvatarSvg" class="profile-avatar"></div>
  </div>

  <div class="username">{{ user.username }}</div>

  {% if current_user.is_authenticated and current_user.id == user.id %}
    <div class="stats">
      ì¹œêµ¬ ìˆ˜: <strong>{{ friends|length }}</strong> |
      ë°›ì€ í¸ì§€ ìˆ˜: <strong>{{ letters|length }}</strong> |
      ì˜¤ëŠ˜ ë°©ë¬¸ì ìˆ˜: <strong>{{ today_visits }}</strong>
    </div>

    <!-- ğŸ”¥ ë‚´ í”„ë¡œí•„ì—ë§Œ ë³´ì´ëŠ” ì§ˆë¬¸ ë§í¬ ë³µì‚¬ ë²„íŠ¼ -->
    <div class="copy-link-wrapper">
      <input type="text" id="profileLink" value="{{ url_for('public_profile', username=user.username, _external=True) }}" readonly style="opacity:0; position:absolute;">
      <button class="copy-button" onclick="copyProfileLink()">ğŸ“‹ ë§í¬ ë³µì‚¬</button>
    </div>
  {% endif %}

  <!-- ğŸ”¥ í”ŒëŸ¬ìŠ¤ ë²„íŠ¼ (íšŒì›/ë¹„íšŒì› ëª¨ë‘ ë³´ì´ê²Œ) -->
<div class="plus-button-wrapper">
  <a href="{{ url_for('write_letter_page', username=user.username) }}">
    <button class="plus-button">ï¼‹</button>
  </a>
</div>

<!-- ğŸ”¥ í¸ì§€ ë¦¬ìŠ¤íŠ¸ -->
{% if current_user.is_authenticated and current_user.id == user.id %}
  <div class="letter-list">
    {% for letter in letters %}
      {% set can_open = (current_user.id == letter.receiver_id or current_user.id == letter.sender_id or letter.is_public) %}

      {% if can_open %}
        <a href="{{ url_for('letter_detail', letter_id=letter.id) }}" class="letter-item">
      {% else %}
        <div class="letter-item disabled-letter" title="ë¹„ê³µê°œ í¸ì§€ëŠ” ì—´ëŒí•  ìˆ˜ ì—†ì–´ìš”">
      {% endif %}
      
        <div id="icon-{{ letter.id }}" class="letter-icon"></div>

      {% if can_open %}
        </a>
      {% else %}
        </div>
      {% endif %}
    {% endfor %}
  </div>
{% else %}
  <div class="login-required">
    <p>ğŸ“¢ í¸ì§€ë¥¼ ë³´ë ¤ë©´ ë¡œê·¸ì¸ í•´ì£¼ì„¸ìš”!</p>
  </div>
{% endif %}
{% endblock %}

{% block scripts %}
{{ super() }}

<script>
document.addEventListener("DOMContentLoaded", () => {
  // âœ… ì‚¬ìš©ì ì•„ë°”íƒ€ SVG ì ìš©
  const avatarDiv = document.getElementById("userAvatarSvg");
  const fname = "{{ user.avatar_filename }}";
  const col = "{{ user.avatar_color }}";

  fetch(`/static/avatars/${fname}`)
    .then(r => r.text())
    .then(svg => {
      const coloredSvg = svg
        .replace(/#D9D9D9|#FFFFFF/gi, col)
        .replace(/<svg[^>]+>/, match => 
          match.replace(/width="[^"]*"/, 'width="240px"')
               .replace(/height="[^"]*"/, 'height="240px"')
        );
      avatarDiv.innerHTML = coloredSvg;
    });

  {% if current_user.is_authenticated and current_user.id == user.id and letters %}
    // âœ… í¸ì§€ ì•„ì´ì½˜ SVG ì ìš© (ë¡œê·¸ì¸í•˜ê³  ë‚´ í”„ë¡œí•„ì¼ ë•Œë§Œ)
    const applySVG = (targetId, rawSvg, color) => {
      const colored = rawSvg
        .replace(/#D9D9D9|#FFFFFF/gi, color)
        .replace(/<svg[^>]+>/, match =>
          match.replace(/width="[^"]*"/, 'width="100px"')
               .replace(/height="[^"]*"/, 'height="100px"')
        );
      document.getElementById(targetId).innerHTML = colored;
    };

    {% for letter in letters %}
      {% if not letter.is_public and not letter.is_read %}
        fetch("/static/icons/envelope.svg")
          .then(r => r.text())
          .then(svg => applySVG("icon-{{ letter.id }}", svg, "{{ letter.color }}"));

      {% elif not letter.is_public and letter.is_read %}
        fetch("/static/icons/qlrhdro.svg")
          .then(r => r.text())
          .then(svg => applySVG("icon-{{ letter.id }}", svg, "{{ letter.color }}"));

      {% elif letter.is_public and not letter.is_read %}
        fetch("/static/icons/envelope.svg")
          .then(r => r.text())
          .then(svg => applySVG("icon-{{ letter.id }}", svg, "{{ letter.color }}"));

      {% elif letter.is_public and letter.is_read and letter.is_anonymous %}
        fetch("/static/icons/profile.svg")
          .then(r => r.text())
          .then(svg => applySVG("icon-{{ letter.id }}", svg, "{{ letter.color }}"));

      {% elif letter.is_public and letter.is_read and not letter.is_anonymous %}
        fetch("/static/avatars/{{ letter.sender.avatar_filename }}")
          .then(r => r.text())
          .then(svg => applySVG("icon-{{ letter.id }}", svg, "{{ letter.sender.avatar_color }}"));
      {% endif %}
    {% endfor %}
  {% endif %}
});

// âœ… ë³µì‚¬ ë²„íŠ¼ ìŠ¤í¬ë¦½íŠ¸
function copyProfileLink() {
    var copyText = document.getElementById("profileLink");
    copyText.select();
    copyText.setSelectionRange(0, 99999); // ëª¨ë°”ì¼ ëŒ€ì‘
    document.execCommand("copy");
    alert("ë§í¬ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ“‹ ì¹œêµ¬ë“¤ì—ê²Œ ê³µìœ í•´ ë³´ì„¸ìš”.");
}
</script>
{% endblock %}
