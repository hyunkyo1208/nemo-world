{% extends "base.html" %}

{% block content %}
<div class="register-full-wrapper">
  <div class="register-form-area">
    <h2 class="text-center mb-4"> íšŒì›ê°€ì… </h2>

    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="alert alert-{{ category }} text-center" role="alert">
            {{ message }}
          </div>
        {% endfor %}
      {% endif %}
    {% endwith %}

    <form method="post">
      <!-- íŒ¨ì‹œìš©ì í‚¤ ì…ë ¥ -->
      <div class="mb-4">
        <label for="userid" class="form-label text-start d-block">ì•„ì´ë””</label>
        <div class="d-flex gap-2">
          <input type="text" name="userid" id="userid" class="form-control" required pattern="[A-Za-z0-9]{4,16}" title="ì˜ë¬¸+ìˆ«ì 4~16ì">
          <button type="button" class="btn btn-outline-secondary" onclick="checkUserId()">ì¤‘ë³µ í™•ì¸</button>
        </div>
        <div id="useridFeedback" class="form-text mt-1"></div>
      </div>

      <div class="mb-4">
        <label for="username" class="form-label text-start d-block">ì´ë¦„</label>
        <input type="text" name="username" id="username" class="form-control" required>
      </div>

      <div class="mb-4">
        <label for="email" class="form-label text-start d-block">ì´ë©”ì¼</label>
        <input type="email" name="email" id="email" class="form-control" required>
      </div>

      <div class="mb-4">
        <label for="password" class="form-label text-start d-block">ë¹„ë°€ë²ˆí˜¸</label>
        <input type="password" name="password" id="password" class="form-control" required>
      </div>

      <div class="mb-4">
        <label class="form-label text-start d-block">ğŸŒˆ ìƒ‰ìƒ ì„ íƒ</label>
        <div class="advanced-color mt-2">
          <input type="color" id="customColor" class="form-control form-control-color" value="#E6C69B">
        </div>
        <input type="hidden" name="avatarColor" id="avatarColorInput" value="#E6C69B">
      </div>

      <div class="mb-4">
        <label class="form-label text-start d-block">ğŸ¾ ì•„ë°”í„° ì„ íƒ</label>
        <div class="avatar-grid">
          {% for avatar in avatars %}
          <div class="avatar-option" onclick="selectAvatar('{{ avatar }}')">
            <img src="{{ url_for('static', filename='avatars/' + avatar) }}" alt="avatar">
          </div>
          {% endfor %}
        </div>
        <input type="hidden" id="selectedAvatar" name="selectedAvatar">
      </div>

      <div class="preview-box text-center mt-4 mb-5">
        <p class="mb-3">âœ¨ ì•„ë°”í„° ë¯¸ë¦¬ë³´ê¸° âœ¨</p>
        <div id="avatarPreview">
          <svg id="avatarSvg" width="140" height="140"></svg>
        </div>
      </div>

      <div class="form-group text-start mb-4" style="font-size: 0.95rem;">
        <div class="form-check mb-2">
          <input class="form-check-input" type="checkbox" id="terms" name="terms" required>
          <label class="form-check-label" for="terms">
            (í•„ìˆ˜) <a href="#" onclick="openModal('terms')">ì´ìš©ì•½ê´€</a>ì— ë™ì˜í•©ë‹ˆë‹¤.
          </label>
        </div>

        <div class="form-check mb-2">
          <input class="form-check-input" type="checkbox" id="privacy" name="privacy" required>
          <label class="form-check-label" for="privacy">
            (í•„ìˆ˜) <a href="#" onclick="openModal('privacy')">ê°œì¸ì •ë³´ ìˆ˜ì§‘ ë° ì´ìš©</a>ì— ë™ì˜í•©ë‹ˆë‹¤.
          </label>
        </div>

        <div class="form-check">
          <input class="form-check-input" type="checkbox" id="marketing" name="marketing">
          <label class="form-check-label" for="marketing">
            (ì„ íƒ) ë§ˆì¼€íŒ… ì •ë³´ ìˆ˜ì‹ ì— ë™ì˜í•©ë‹ˆë‹¤.
          </label>
        </div>
      </div>

      <!-- ëª¨ë‹¬ ì°¾ -->
      <div id="modalBackground" class="modal-bg" style="display: none;">
        <div class="modal-content">
          <h4 id="modalTitle"></h4>
          <div id="modalBody" class="modal-body-text"></div>
          <button class="btn btn-secondary mt-3" onclick="closeModal()">ë‹«ê¸°</button>
        </div>
      </div>

      <button type="submit" class="btn btn-custom w-100 mt-4">íšŒì›ê°€ì…</button>
      <p class="text-center mt-4" style="font-size: 17px;">ì´ë¯¸ ê³„ì •ì´ ìˆìŠµë‹ˆê¹Œ? <a href="{{ url_for('login') }}">ë¡œê·¸ì¸</a>
      </p>
    </form>
  </div>
</div>

<script>
function selectAvatar(avatar) {
  document.getElementById("selectedAvatar").value = avatar;
  fetch(`/static/avatars/${avatar}`)
    .then(response => response.text())
    .then(svgText => {
      document.getElementById("avatarSvg").innerHTML = svgText;
      applyColorToSvg(document.getElementById("customColor").value);
    });
}

function applyColorToSvg(color) {
  const svg = document.getElementById("avatarSvg").querySelector("svg");
  if (!svg) return;
  svg.querySelectorAll("[fill]").forEach(el => {
    if (el.getAttribute("fill").toUpperCase() === "#D9D9D9") {
      el.setAttribute("fill", color);
    }
  });
}

function checkUserId() {
  const userid = document.getElementById('userid').value.trim();
  const feedback = document.getElementById('useridFeedback');

  if (!userid) {
    feedback.textContent = "ì•„ì´ë””ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.";
    feedback.style.color = "red";
    return;
  }

  fetch(`/check_userid?userid=${encodeURIComponent(userid)}`)
    .then(res => res.json())
    .then(data => {
      feedback.textContent = data.exists ? "ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ì•„ì´ë””ì…ë‹ˆë‹¤." : "ì‚¬ìš© ê°€ëŠ¥í•œ ì•„ì´ë””ì…ë‹ˆë‹¤!";
      feedback.style.color = data.exists ? "red" : "green";
    })
    .catch(() => {
      feedback.textContent = "ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
      feedback.style.color = "red";
    });
}

function openModal(type) {
  const modal = document.getElementById('modalBackground');
  const title = document.getElementById('modalTitle');
  const body = document.getElementById('modalBody');

  if (type === 'terms') {
    title.innerText = "ì´ìš©ì•½ê´€";
    body.innerText = `1. ëª©ì 
ë³¸ ì•½ê´€ì€ 'ë„¤ëª¨ì˜ ì„¸ìƒ' ì„œë¹„ìŠ¤(ì´í•˜ "ì„œë¹„ìŠ¤")ì˜ ì´ìš© ì¡°ê±´ ë° ì ˆì°¨ë¥¼ ê·œì •í•¨ì„ ëª©ì ìœ¼ë¡œ í•©ë‹ˆë‹¤.

2. ê°€ì… ë° ì´ìš© ì¡°ê±´
ë³¸ ì„œë¹„ìŠ¤ëŠ” ë§Œ 14ì„¸ ì´ìƒì˜ ì‚¬ìš©ìë§Œ ì´ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

3. ì´ìš©ìì˜ ì˜ë¬´
- íƒ€ì¸ì˜ ì •ë³´ë¥¼ ë¬´ë‹¨ìœ¼ë¡œ ì‚¬ìš©í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
- ì„œë¹„ìŠ¤ ì´ìš© ì‹œ ë²•ë ¹ ë° ê³µì„œì–‘ì†ì„ ì¤€ìˆ˜í•´ì•¼ í•©ë‹ˆë‹¤.

4. íšŒì‚¬ì˜ ê¶Œë¦¬ì™€ ì±…ì„
íšŒì‚¬ëŠ” ì„œë¹„ìŠ¤ì˜ ì¼ë¶€ ë˜ëŠ” ì „ë¶€ë¥¼ ë³€ê²½í•˜ê±°ë‚˜ ì¤‘ë‹¨í•  ìˆ˜ ìˆìœ¼ë©°, ì´ì— ëŒ€í•´ ë³„ë„ì˜ ë³´ìƒì„ í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.

5. ì§€ì  ì¬ì‚°ê¶Œ
ì„œë¹„ìŠ¤ ë‚´ ëª¨ë“  ì½˜í…ì¸ ì— ëŒ€í•œ ì €ì‘ê¶Œ ë° ì§€ì  ì¬ì‚°ê¶Œì€ íšŒì‚¬ì— ê·€ì†ë©ë‹ˆë‹¤.

6. ë¶„ìŸ í•´ê²°
ë³¸ ì•½ê´€ì€ ëŒ€í•œë¯¼êµ­ ë²•ë¥ ì— ë”°ë¼ í•´ì„ë˜ë©°, ì„œë¹„ìŠ¤ì™€ ê´€ë ¨ëœ ë¶„ìŸì€ ì„œìš¸ì¤‘ì•™ì§€ë°©ë²•ì›ì„ ì œ1ì‹¬ ê´€í•  ë²•ì›ìœ¼ë¡œ í•©ë‹ˆë‹¤.
`;
  } else if (type === 'privacy') {
    title.innerText = "ê°œì¸ì •ë³´ ìˆ˜ì§‘ ë° ì´ìš©";
    body.innerText = `1. ìˆ˜ì§‘ í•­ëª©
- í•„ìˆ˜ í•­ëª©: ì•„ì´ë””, ë¹„ë°€ë²ˆí˜¸, ì´ë¦„, ì´ë©”ì¼, ì•„ë°”íƒ€ ì„¤ì • ì •ë³´
- ì„ íƒ í•­ëª©: ë§ˆì¼€íŒ… ì •ë³´ ìˆ˜ì‹  ë™ì˜

2. ìˆ˜ì§‘ ëª©ì 
- íšŒì› ì‹ë³„ ë° ê´€ë¦¬
- ì„œë¹„ìŠ¤ ì œê³µ ë° ê°œì„ 
- ì‚¬ìš©ì ë§ì¶¤í˜• ì„œë¹„ìŠ¤ ì œê³µ

3. ë³´ìœ  ë° ì´ìš© ê¸°ê°„
- íšŒì› íƒˆí‡´ ì‹œê¹Œì§€ ë³´ìœ  í›„ ì¦‰ì‹œ íŒŒê¸°í•©ë‹ˆë‹¤.

4. ë™ì˜ ê±°ë¶€ ê¶Œë¦¬ ë° ë¶ˆì´ìµ
- ê°œì¸ì •ë³´ ì œê³µì— ë™ì˜í•˜ì§€ ì•Šìœ¼ì‹¤ ìˆ˜ ìˆìœ¼ë‚˜, ì´ ê²½ìš° íšŒì›ê°€ì… ë° ì„œë¹„ìŠ¤ ì´ìš©ì´ ì œí•œë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
`;
  }
  modal.style.display = 'flex';
}

function closeModal() {
  document.getElementById('modalBackground').style.display = 'none';
}

document.addEventListener("DOMContentLoaded", () => {
  const customColorInput = document.getElementById("customColor");
  const hiddenInput = document.getElementById("avatarColorInput");

  customColorInput.addEventListener("input", () => {
    hiddenInput.value = customColorInput.value;
  });
});
</script>

{% endblock %}
